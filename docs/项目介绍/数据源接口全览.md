# SilverQuant数据源接口全览

## 数据源概览

### QMT (xtquant)
- 位置: xtquant/xtdata.py
- 定位: 主力数据源
- 功能
  - 实盘交易
  - 实时行情
  - 历史数据
  - 交易接口

### Tushare
- 位置: reader/tushare_agent.py
- 定位: 历史数据补充
- 功能
  - 日线数据
  - 财务数据
  - 支持token轮换

### AKShare
- 位置: tools/utils_remote.py
- 定位: 免费数据源
- 功能
  - 股票历史数据
  - ETF数据
  - 支持复权

### Mootdx
- 位置: tools/utils_mootdx.py
- 定位: 通达信本地
- 功能
  - 本地数据访问
  - 速度最快
  - 无网络依赖

### 文财Pywencai
- 位置: tools/utils_remote.py
- 定位: AI选股
- 功能
  - 自然语言查询
  - 条件选股

### 掘金GMTrade
- 位置: delegate/gm_delegate.py
- 定位: 模拟盘
- 功能
  - 模拟交易
  - 策略回测

## QMT数据接口详解

### 连接管理
- connect(ip, port)
  - 连接QMT服务
  - 自动扫描端口
- reconnect()
  - 重新连接
- disconnect()
  - 断开连接
- get_client()
  - 获取客户端实例

### 实时行情接口

#### 全推数据
- get_full_tick(code_list)
  - 参数: 股票代码列表
  - 返回: 实时行情字典
  - 字段
    - time: 时间戳
    - lastPrice: 最新价
    - open/high/low: 开高低
    - lastClose: 昨收
    - askPrice: 卖五档
    - bidPrice: 买五档
    - askVol: 卖量
    - bidVol: 买量
    - volume: 成交量
    - amount: 成交额

#### 行情订阅
- subscribe_quote(code, period, count)
  - 订阅实时行情
  - 支持周期: tick/1m/5m/1d
- subscribe_whole_quote(code_list)
  - 批量订阅
- unsubscribe_quote(code, period)
  - 取消订阅

### 历史K线接口

#### 获取数据
- get_market_data()
  - 参数
    - field_list: 字段列表
    - stock_list: 股票列表
    - period: 周期(1m/5m/1d/1w/1mon)
    - start_time: 开始时间(YYYYMMDD)
    - end_time: 结束时间(YYYYMMDD)
    - count: 数量(-1全部)
    - dividend_type: 复权(none/front/back)
  - 返回: Dict[code, DataFrame]

#### 本地缓存
- get_local_data()
  - 参数同get_market_data
  - 优势: 速度更快
  - 要求: 需先下载数据

#### 数据下载
- download_history_data(code, period, start, end, incrementally)
  - 下载单个股票
  - incrementally: 增量下载
- download_history_data2(codes, period, start, end, callback)
  - 批量下载
  - callback: 进度回调

### L2深度行情

#### L2委托
- get_l2_order(fields, code, start, end, count)
  - 逐笔委托数据
  - Level-2权限

#### L2成交
- get_l2_transaction(fields, code, start, end, count)
  - 逐笔成交数据
  - 高频交易必备

#### L2快照
- get_l2_quote(fields, code, start, end, count)
  - L2行情快照
  - 完整盘口数据

### 财务数据接口

#### 获取财务数据
- get_financial_data()
  - 参数
    - stock_list: 股票列表
    - table_list: 财务表
      - Capital: 股本结构
      - Income: 利润表
      - CashFlow: 现金流量表
      - Balance: 资产负债表
    - start_time: 开始时间
    - end_time: 结束时间
    - report_type: 报告类型
      - report_time: 报告期
      - announce_time: 公告期
  - 返回: Dict[code, Dict[table, DataFrame]]

#### 下载财务数据
- download_financial_data(stocks, tables, start, end, incrementally)
  - 批量下载
  - 增量更新

### 市场信息接口

#### 交易日历
- get_trading_dates(market, start, end, count)
  - 参数
    - market: 市场(SH/SZ/BJ)
    - start_time: 开始日期
    - end_time: 结束日期
  - 返回: 交易日列表

#### 股票列表
- get_stock_list_in_sector(sector_name, real_timetag)
  - 获取板块成分股
  - sector_name: 板块名称
  - 示例: '沪深A股'/'创业板'

#### 板块管理
- get_sector_list()
  - 获取所有板块
- add_sector(name, code_list)
  - 添加自定义板块
- remove_sector(name)
  - 删除板块

#### 指数权重
- get_index_weight(index_code)
  - 获取指数成分权重
  - 示例: '000300.SH'(沪深300)
- download_index_weight()
  - 下载指数权重数据

### 除权除息数据

#### 除权因子
- get_divid_factors(code, start, end)
  - 获取除权因子
  - 字段
    - dividend: 分红
    - split: 拆股
    - allotment: 配股

### 合约信息接口

#### 合约详情
- get_instrument_detail(code, iscomplete)
  - 获取单个合约详情
  - iscomplete: 是否完整信息
- get_instrument_detail_list(codes, iscomplete)
  - 批量获取

#### 合约类型
- get_instrument_type(code, variety_list)
  - 判断合约类型
  - 返回: 股票/期货/期权

#### 主力合约
- get_main_contract(code_market, start, end)
  - 获取期货主力合约
  - code_market: 品种代码(IF/IC/IH)
- download_history_contracts(incrementally)
  - 下载历史合约

### ETF数据接口

#### ETF信息
- get_etf_info()
  - 获取所有ETF信息
  - 字段
    - 基金代码
    - 基金名称
    - 申购赎回代码
    - 最小申购单位
- download_etf_info()
  - 下载ETF数据

### 其他专项数据

#### 新股数据
- get_ipo_info(start, end)
  - 新股发行信息
  - 申购日期/代码

#### 可转债数据
- get_cb_info(code)
  - 可转债信息
- download_cb_data()
  - 下载可转债数据

#### ST股票
- get_his_st_data(code)
  - 历史ST状态
- download_his_st_data()
  - 下载ST数据

#### 节假日
- get_holidays()
  - 获取节假日列表
- get_trading_calendar(market, start, end)
  - 交易日历

### 自定义公式

#### 表格数据
- get_tabular_data()
  - 参数
    - stock_list: 股票列表
    - field_list: 字段列表
    - period: 周期
    - start_time: 开始时间
    - end_time: 结束时间
  - 功能: 支持自定义公式计算
- download_tabular_data()
  - 下载表格数据

## Tushare数据接口

### 初始化配置
- get_tushare_pro(account_number)
  - 获取API实例
  - 自动token轮换
  - 配置文件: reader/tushare_token.py

### 日线数据

#### 单股票查询
- get_ts_daily_history()
  - 参数
    - code: 股票代码(000001.SZ)
    - start_date: 开始(YYYYMMDD)
    - end_date: 结束(YYYYMMDD)
    - columns: 字段列表
  - 返回: 标准化DataFrame
  - 字段
    - datetime: 日期(int)
    - open/high/low/close: OHLC
    - volume: 成交量(手)
    - amount: 成交额(元)

#### 批量查询
- get_ts_daily_histories()
  - 参数
    - codes: 代码列表
    - start_date: 开始日期
    - end_date: 结束日期
  - 返回: Dict[code, DataFrame]
  - 限制: 单次最多8000行

### 数据特点
- 免费版不支持复权
- 不支持ETF数据
- 自动重试机制(3次)
- Token轮换避免限流

## AKShare数据接口

### 历史日线

#### 获取数据
- get_ak_daily_history()
  - 参数
    - code: 代码(不带后缀)
    - start_date: 开始(YYYYMMDD)
    - end_date: 结束(YYYYMMDD)
    - columns: 字段列表
    - adjust: 复权类型
      - ExitRight.BFQ: 不复权
      - ExitRight.QFQ: 前复权
      - ExitRight.HFQ: 后复权
  - 返回: 标准化DataFrame

### 支持品种
- A股
  - 沪深主板
  - 创业板
  - 科创板
  - 北交所
- ETF基金

### 数据特点
- 完全免费
- 支持复权(全历史复权后截取)
- A股两位小数
- ETF三位小数
- 网络请求较慢

### 实时数据辅助
- concat_ak_quote_dict(df, quote, date)
  - 拼接实时行情到历史
  - quote: QMT行情字典
- append_ak_spot_dict(df, row, date)
  - 追加现货数据

## Mootdx数据接口

### 初始化
- MootdxClientInstance()
  - 单例模式
  - 自动连接通达信
  - 配置: TDX_FOLDER路径

### 实时行情
- get_mootdx_quotes(code_list)
  - 参数: 代码列表
  - 返回: 标准行情字典
  - 格式同get_full_tick

### 历史日线

#### 获取数据
- get_mootdx_daily_history()
  - 参数
    - code: 股票代码
    - start_date: 开始(YYYYMMDD)
    - end_date: 结束(YYYYMMDD)
    - columns: 字段列表
    - adjust: 复权类型
  - 返回: 标准DataFrame

#### 复权实现
- make_qfq(data, xdxr)
  - 前复权计算
  - 基于通达信xdxr数据
- make_hfq(data, xdxr)
  - 后复权计算

### 除权数据
- client.xdxr(symbol)
  - 获取除权除息
  - 字段
    - year/month/day: 日期
    - fenhong: 分红
    - peigu: 配股数
    - peigujia: 配股价
    - songzhuangu: 送转股

### 数据特点
- 本地访问速度最快
- 无网络依赖
- 需通达信客户端
- 不支持部分北交所
- 可能存在历史脏数据

## 文财选股接口

### AI选股
- get_wencai_codes(queries)
  - 参数
    - queries: 查询条件列表
  - 返回: 股票代码列表
  - 示例
    - "市盈率小于20"
    - "市值大于100亿"
    - "昨日涨幅大于5%"

### 使用特点
- 自然语言查询
- 支持复杂条件组合
- 每次最多100条
- loop=True自动翻页
- 频率限制(建议30秒间隔)
- 需配置代理避免封IP

## 掘金数据接口

### 连接初始化
- set_endpoint(host)
  - 服务地址: api.myquant.cn:9000
- set_token(token)
  - 设置访问令牌
- account(account_id)
  - 创建账户对象
- login(account)
  - 登录账户

### 交易接口

#### 买入操作
- order_market_open()
  - 市价买入
  - 参数
    - code: 股票代码
    - price: 参考价
    - volume: 数量
    - remark: 备注
- order_limit_open()
  - 限价买入

#### 卖出操作
- order_market_close()
  - 市价卖出
- order_limit_close()
  - 限价卖出

#### 委托管理
- order_cancel_all()
  - 全部撤单
- order_cancel_buy(code)
  - 撤买单
- order_cancel_sell(code)
  - 撤卖单

### 账户查询

#### 资金查询
- check_asset()
  - 返回GmAsset对象
  - 字段
    - cash: 可用资金
    - total_asset: 总资产
    - market_value: 市值
    - frozen_cash: 冻结资金

#### 持仓查询
- check_positions()
  - 返回List[GmPosition]
  - 字段
    - stock_code: 代码
    - volume: 持仓量
    - can_use_volume: 可用量
    - open_price: 成本价
    - market_value: 市值

#### 委托查询
- check_orders()
  - 返回List[GmOrder]
  - 字段
    - stock_code: 代码
    - order_volume: 委托量
    - price: 委托价
    - order_status: 状态

### 数据特点
- 模拟盘免费
- 支持A股/期货/期权
- 提供历史数据API
- 实盘需付费

## 统一数据接口

### 通用历史数据
- get_daily_history()
  - 参数
    - code: 股票代码
    - start_date: 开始日期
    - end_date: 结束日期
    - columns: 字段列表
    - adjust: 复权类型
    - data_source: 数据源
      - DataSource.AKSHARE
      - DataSource.TUSHARE
      - DataSource.MOOTDX
  - 返回: 统一格式DataFrame

### 数据格式标准

#### 统一字段
- datetime: int(YYYYMMDD)
- open: float
- high: float
- low: float
- close: float
- volume: int(手)
- amount: float(元)

### 通达信自选股

#### 写入自选
- set_tdx_zxg_code(codes, filename)
  - codes: 代码列表
  - filename: 文件路径
  - 默认: TDX/T0002/blocknew/ZXG.blk

#### 读取自选
- get_tdx_zxg_code(filename)
  - 返回: 代码列表

## 数据格式转换

### QMT格式转换
- qmt_quote_to_tick(quote)
  - QMT行情转Tick格式
  - 字段
    - time: 时分秒
    - price/high/low: 价格
    - volume/amount: 量额
    - askPrice/bidPrice: 盘口
    - askVol/bidVol: 盘量
- qmt_quote_to_day_kline(quote, date)
  - QMT行情转日K线

## 项目数据流架构

### 实盘交易流程
- 数据输入
  - QMT实时行情
    - get_full_tick
    - subscribe_quote
  - 文财选股信号
    - get_wencai_codes
- 处理层
  - XtDelegate封装
  - 策略执行引擎
- 交易输出
  - QMT下单接口
  - 钉钉消息推送

### 模拟盘流程
- 数据输入
  - 掘金行情API
  - 文财选股信号
- 处理层
  - GmDelegate封装
  - 模拟策略执行
- 交易输出
  - 掘金模拟下单
  - 策略测试验证

### 历史回测流程
- 数据源选择
  - Mootdx(速度优先)
    - 本地数据
    - 最快访问
  - AKShare(免费复权)
    - 网络数据
    - 复权支持
  - Tushare(备用补充)
    - 数据全面
    - Token轮换
- 处理层
  - 回测引擎
  - 策略验证
- 输出结果
  - 性能指标
  - 收益曲线

## 数据源对比

### 功能对比矩阵

#### QMT特点
- 实时行情: 支持
- 历史数据: 支持
- 复权支持: 支持
- 财务数据: 支持
- 访问速度: 极快(5星)
- 使用费用: 较高
- 适用场景: 实盘交易

#### Tushare特点
- 实时行情: 不支持
- 历史数据: 支持
- 复权支持: 付费版
- 财务数据: 支持
- 访问速度: 中等(3星)
- 使用费用: 基础免费
- 适用场景: 数据分析

#### AKShare特点
- 实时行情: 不支持
- 历史数据: 支持
- 复权支持: 支持
- 财务数据: 不支持
- 访问速度: 较慢(2星)
- 使用费用: 完全免费
- 适用场景: 回测研究

#### Mootdx特点
- 实时行情: 支持
- 历史数据: 支持
- 复权支持: 支持
- 财务数据: 不支持
- 访问速度: 极快(5星)
- 使用费用: 完全免费
- 适用场景: 快速回测

#### 文财特点
- 实时行情: 不支持
- 历史数据: 不支持
- 复权支持: 不支持
- 财务数据: 不支持
- 访问速度: 较慢(2星)
- 使用费用: 完全免费
- 适用场景: AI选股

#### 掘金特点
- 实时行情: 支持
- 历史数据: 支持
- 复权支持: 支持
- 财务数据: 支持
- 访问速度: 快(4星)
- 使用费用: 模拟免费
- 适用场景: 模拟盘

### 场景选择建议

#### 实盘交易推荐
- 主数据源: QMT
  - 实时行情
  - 交易下单
- 选股辅助: 文财
  - 条件筛选
- 备用方案: 掘金
  - 模拟测试

#### 历史回测推荐
- 首选: Mootdx
  - 本地速度快
  - 无网络限制
- 备选: AKShare
  - 免费支持复权
  - 数据完整
- 补充: Tushare
  - 数据全面
  - 财务数据

#### 数据分析推荐
- 日线数据: AKShare/Tushare
- 财务数据: Tushare/QMT
- 指标计算: QMT tabular_data

## 最佳实践

### 数据获取策略

#### 优先级设计
- 实时策略
  - 第一选择: QMT get_full_tick
  - 备用方案: Mootdx quotes
- 历史回测
  - 第一选择: Mootdx(本地快)
  - 第二选择: AKShare(免费全)
  - 备用方案: Tushare(数据补充)
- 财务数据
  - 第一选择: Tushare
  - 备用方案: QMT

### 缓存机制

#### 内存缓存
- 数据结构
  - cache_history: Dict[code, DataFrame]
- 使用场景
  - 频繁访问的历史数据
  - 减少重复查询

#### 本地缓存
- QMT下载机制
  - download_history_data
  - incrementally=True增量更新
- Mootdx本地数据
  - 通达信数据目录
  - 实时同步

### 频率限制处理

#### 文财限流
- 间隔控制: 30秒
- 避免IP封禁
- 配置代理池

#### Tushare限流
- 自动重试: 3次
- Token轮换机制
- 错误捕获

### 数据标准化

#### 统一格式
- 日期格式: int(YYYYMMDD)
- 价格精度: float
- 成交量: int(手)
- 成交额: float(元)

#### 转换函数
- _ts_to_standard(df)
  - Tushare格式转标准
- qmt_quote_to_tick(quote)
  - QMT行情转Tick
- qmt_quote_to_day_kline(quote, date)
  - QMT行情转K线

## 配置示例

### 系统配置文件
- credentials.py
  - QMT配置
    - QMT_ACCOUNT_ID: 账户ID
    - QMT_CLIENT_PATH: 客户端路径
  - Tushare配置
    - reader/tushare_token.py
    - ts_token: Token列表
  - 掘金配置
    - GM_ACCOUNT_ID: 账户ID
    - GM_CLIENT_TOKEN: 访问令牌
  - 通达信配置
    - TDX_FOLDER: 数据目录

### 完整使用示例
- 历史数据获取
  - 导入模块
  - 选择数据源
  - 设置参数
  - 获取数据
- 实时行情获取
  - 导入xt_delegate
  - 调用get_ticks
  - 解析行情数据
- 选股操作
  - 导入文财接口
  - 构造查询条件
  - 获取代码列表
- 持仓查询
  - 创建delegate实例
  - 调用check_positions
  - 解析持仓信息