"""
{【趋势动能共振选股】By ChatGPT优化版}
{核心逻辑：趋势启动 + 量价突破 + 动量加速}

{————— 参数模块（可自定义调整）—————}
趋势周期:= 20;      {趋势判定周期，建议20~60}
动量周期:= 5;       {短期动量周期，建议5~10}
放量倍数:= 1.5;     {成交量阈值倍数，建议1.2~2.0}
波动过滤:= 3;       {最大ATR波动率%，过滤高风险股}

{————— 核心条件1：趋势强度确认 —————}
{动态均线系统}
MA_趋势线:= EMA(C, 趋势周期);          {EMA平滑长期趋势}
趋势角度:= ATAN((MA_趋势线/REF(MA_趋势线,1)-1)*100)*180/3.1416;  {计算趋势线角度}
COND_趋势:= 趋势角度 > 15;            {趋势线上升角度>15度（强势标准）}

{————— 核心条件2：量价突破验证 —————}
{量能突破}
VOL_基准:= MA(V, 动量周期);           {动态成交量基准}
COND_放量:= V > VOL_基准 * 放量倍数 AND C > REF(HHV(H, 动量周期),1);  {放量突破近期高点}

{价格动量}
RSI_动量:= SMA(MAX(C-REF(C,1),0, 动量周期)/SMA(ABS(C-REF(C,1)), 动量周期)*100;  {动量RSI}
COND_动量:= RSI_动量 > 60 AND RSI_动量 > REF(RSI_动量, 3);  {动量持续增强}

{————— 核心条件3：风险控制模块 —————}
{波动率过滤}
ATR值:= MA(MAX(MAX(H-L,ABS(REF(C,1)-H)),ABS(REF(C,1)-L)), 动量周期);
COND_波动:= (ATR值/C) < 波动过滤/100;   {排除日内波动过大的股票}

{流动性过滤}
COND_流动性:= V > MA(V, 30) * 0.5;      {成交量不低于30日均量的一半}

{————— 综合选股条件 —————}
选股信号:
    COND_趋势 AND     {趋势处于强势阶段}
    COND_放量 AND     {量价突破关键位}
    COND_动量 AND     {短期动量加速}
    COND_波动 AND     {波动率可控}
    COND_流动性;     {基础流动性保障}
"""

from mytt.MyTT import *
from mytt.MyTT_advance import *
from mytt.MyTT_custom import *


def select(df: pd.DataFrame, code: str, quote: dict):
    C = df.close
    H = df.high
    L = df.low
    V = df.volume

    # ————— 参数模块（可自定义调整）—————
    趋势周期 = 20  # 趋势判定周期，建议20~60
    动量周期 = 5  # 短期动量周期，建议5~10
    放量倍数 = 1.5  # 成交量阈值倍数，建议1.2~2.0
    波动过滤 = 3  # 最大ATR波动率%，过滤高风险股

    # ————— 核心条件1：趋势强度确认 —————
    # 动态均线系统
    MA_趋势线 = EMA(C, 趋势周期)  # EMA平滑长期趋势
    趋势角度 = ATAN((MA_趋势线 / REF(MA_趋势线, 1) - 1) * 100) * 180 / 3.1416  # 计算趋势线角度
    COND_趋势 = 趋势角度 > 15  # 趋势线上升角度>15度（强势标准）

    # ————— 核心条件2：量价突破验证 —————
    # 量能突破
    VOL_基准 = MA(V, 动量周期)  # 动态成交量基准
    COND_放量 = (V > VOL_基准 * 放量倍数) & (C > REF(HHV(H, 动量周期), 1))  # 放量突破近期高点

    # 价格动量
    RSI_动量 = SMA(MAX(C - REF(C, 1), 0), 动量周期) / SMA(ABS(C - REF(C, 1)), 动量周期) * 100  # 动量RSI
    COND_动量 = (RSI_动量 > 60) & (RSI_动量 > REF(RSI_动量, 3))  # 动量持续增强

    # ————— 核心条件3：风险控制模块 —————
    # 波动率过滤
    ATR值 = MA(MAX(MAX(H - L, ABS(REF(C, 1) - H)), ABS(REF(C, 1) - L)), 动量周期)
    COND_波动 = (ATR值 / C) < 波动过滤 / 100  # 排除日内波动过大的股票

    # 流动性过滤
    COND_流动性 = V > MA(V, 30) * 0.5  # 成交量不低于30日均量的一半

    # ————— 综合选股条件 —————
    # 趋势处于强势阶段
    # 量价突破关键位
    # 短期动量加速
    # 波动率可控
    # 基础流动性保障
    选股信号 = COND_趋势 & COND_放量 & COND_动量 & COND_波动 & COND_流动性

    df['PASS'] = 选股信号

    return df
