# Feature Specification: 数据存储模块性能优化

**Feature Branch**: `001-data-storage-optimization`
**Created**: 2025-10-01
**Last Updated**: 2025-10-01
**Status**: Ready for Implementation
**Input**: 用户描述: "在现有纯文件存储架构基础上,优化数据存储性能,支持多账户管理、策略参数版本化、Web管理后台,解决性能瓶颈和业务复杂度问题"

**📊 实施参考**:
- `impact-analysis.md` - 现有功能影响分析、优劣对比、三阶段实施方案
- `spec-detailed-backup.md` - 详细技术规范备份(含数据实体设计)

## Execution Flow (main)
```
1. 解析用户描述
   → 识别当前架构痛点:文件锁竞争、查询慢、无并发控制
   → 识别目标:性能优化+业务扩展(2-3账户+参数版本化+Web界面)
2. 提取关键概念
   → 参与者:交易员、策略开发者、系统管理员
   → 核心操作:持仓管理、交易记录查询、策略参数配置、账户管理
   → 数据类型:热数据(持仓状态)、业务数据(账户/策略)、时序数据(K线/交易)
3. 定义用户场景
   → 场景1:交易员实时查看持仓状态(< 1ms响应)
   → 场景2:策略开发者对比不同参数版本效果(< 100ms查询)
   → 场景3:管理员通过Web界面管理多账户(< 150ms响应)
4. 生成功能需求
   → 每个需求可测试且明确
   → 标注依赖关系和优先级
5. 识别关键实体
   → 账户、策略、持仓、交易记录、参数版本
6. 执行审查检查清单
   → ✅ 无实现细节(不指定具体技术栈)
   → ✅ 所有需求可测试
7. 返回:SUCCESS (规范就绪,进入设计阶段)
```

---

## ⚡ Quick Guidelines
- ✅ 关注用户需要什么(WHAT)和为什么(WHY)
- ❌ 避免具体实现细节(HOW)
- 👥 面向业务决策者,而非仅开发者

### 业务背景
当前SilverQuant项目采用纯文件存储(JSON/CSV/Pickle),在单账户场景运行良好,但面临以下业务扩展需求:
1. **多账户管理**: 需要管理2-3个交易账户,支持跨账户统计分析
2. **参数版本化**: 策略参数频繁调整,需要版本化管理和效果对比
3. **Web管理界面**: 6个月内开发Web后台,支持用户权限管理
4. **历史数据查询**: 5年历史数据积累,需要高效查询和分析

现有文件存储在上述场景下存在性能和功能瓶颈,需要架构升级。

---

## User Scenarios & Testing *(mandatory)*

### Primary User Story

**作为交易员**,我需要在盘中快速查看所有账户的实时持仓状态和盈亏情况,以便及时做出交易决策。当前文件读取需要10-20ms,在高频场景下响应较慢,期望优化至1ms以内。

**作为策略开发者**,我需要对比不同参数版本的回测结果,找出最优参数组合。当前参数分散在配置文件中,手动对比效率低且易出错,期望系统化管理并支持快速查询对比。

**作为系统管理员**,我需要通过Web界面管理多个交易账户和策略配置,并设置不同操作员的权限(如只读、交易、管理员),避免误操作风险。

### Acceptance Scenarios

#### 场景1: 实时持仓查询
1. **Given** 系统中有3个账户共持有30只股票
   **When** 交易员打开持仓监控面板
   **Then** 系统在1ms内返回所有持仓状态(代码、持仓天数、最高价、当前盈亏)

2. **Given** 数据存储服务故障
   **When** 交易员查询持仓
   **Then** 系统自动降级到备用存储,返回时间延长至10ms但功能正常

#### 场景2: 策略参数版本管理
1. **Given** 策略"问财选股V1"有5个历史参数版本
   **When** 策略开发者查询版本对比
   **Then** 系统在100ms内返回各版本参数差异和回测收益对比表

2. **Given** 策略开发者修改了参数
   **When** 保存新参数配置
   **Then** 系统自动创建新版本(v6),旧版本标记为非激活但保留历史记录

#### 场景3: 多账户管理
1. **Given** 管理员登录Web管理后台
   **When** 选择"账户管理"菜单
   **Then** 系统在150ms内展示3个账户的总资产、可用资金、持仓市值、当日盈亏

2. **Given** 管理员创建新账户"账户4"
   **When** 提交账户信息(账户ID、券商、初始资金)
   **Then** 系统验证账户ID唯一性,创建成功后返回确认信息

#### 场景4: 交易记录统计查询
1. **Given** 系统存储了3年交易记录(约10万条)
   **When** 用户查询某账户近1年交易记录并按月汇总
   **Then** 系统在500ms内返回月度交易统计(交易次数、总盈亏、胜率)

#### 场景5: 历史K线查询
1. **Given** 系统存储了5000只股票的5年日线数据(约625万条)
   **When** 用户查询某只股票近60日K线
   **Then** 系统在20ms内返回K线数据(日期、开高低收、成交量)

### Edge Cases

#### 性能边界
- **并发访问**: 当3个账户同时更新持仓状态时,系统能否保证数据一致性?
  - 预期:使用原子操作,避免数据竞争

- **大数据量查询**: 查询5年全量K线数据(625万条)时,响应时间是否可接受?
  - 预期:支持分页和日期范围过滤,单次查询限制在10万条以内

#### 错误场景
- **服务故障**: 核心数据服务不可用时,系统如何处理?
  - 预期:自动降级到备用存储,记录错误日志,发送告警通知

- **数据迁移中断**: 从旧存储迁移到新存储时进程异常终止,如何保证数据完整性?
  - 预期:采用双写模式,新旧存储同时更新,保证数据不丢失

- **重复数据**: 用户尝试创建已存在的账户ID时,系统如何响应?
  - 预期:返回错误提示"账户ID已存在",阻止创建操作

#### 数据一致性
- **多数据源同步**: 交易成交后,持仓状态、最高价、交易记录必须保持一致
  - 预期:在交易回调中原子性更新所有相关数据

- **跨存储查询**: 不同存储介质的数据关联查询,如何保证数据时效性?
  - 预期:写入后立即可查询,延迟<1秒

---

## Requirements *(mandatory)*

### Functional Requirements

#### 数据访问性能 (优先级: P0 - 关键)
- **FR-001**: 系统必须在1ms内返回单个账户的持仓状态(持仓天数、最高价、最低价)
- **FR-002**: 系统必须在100ms内返回单个账户近1年的交易记录查询结果
- **FR-003**: 系统必须在20ms内返回单只股票近60日的K线数据
- **FR-004**: 系统必须在500ms内完成跨账户的统计查询(如所有账户总盈亏)

#### 数据持久化与一致性 (优先级: P0 - 关键)
- **FR-005**: 系统必须保证持仓状态的原子性更新(持仓天数+1操作不可被中断)
- **FR-006**: 系统必须在交易成交后1秒内完成所有相关数据更新(持仓状态、交易记录)
- **FR-007**: 系统必须支持数据降级模式:当主存储不可用时自动切换到备用存储
- **FR-008**: 系统必须每日自动备份关键数据(账户信息、策略配置、交易记录)

#### 账户管理 (优先级: P1 - 重要)
- **FR-009**: 系统必须支持创建、查询、修改、停用交易账户
- **FR-010**: 系统必须验证账户ID的唯一性(同一账户ID不可重复创建)
- **FR-011**: 系统必须记录账户的初始资金、当前资金、总资产、持仓市值
- **FR-012**: 系统必须支持查询所有账户列表,并按状态过滤(活跃/停用/暂停)

#### 策略管理 (优先级: P1 - 重要)
- **FR-013**: 系统必须支持创建、查询、修改、停用策略配置
- **FR-014**: 系统必须支持将策略绑定到指定账户,并设置分配资金和风险限额
- **FR-015**: 系统必须支持查询某账户绑定的所有策略,以及某策略绑定的所有账户
- **FR-016**: 系统必须记录策略的类型(问财/远程/技术指标)、版本号、状态

#### 策略参数版本化 (优先级: P1 - 重要)
- **FR-017**: 系统必须支持保存策略参数的多个版本(版本号递增)
- **FR-018**: 系统必须支持查询指定版本的参数配置
- **FR-019**: 系统必须支持对比不同版本的参数差异(以表格形式展示)
- **FR-020**: 系统必须将新版本标记为"当前激活",旧版本自动标记为"历史版本"

#### 交易记录查询 (优先级: P1 - 重要)
- **FR-021**: 系统必须支持按日期范围查询交易记录
- **FR-022**: 系统必须支持按账户、股票代码、策略名称过滤交易记录
- **FR-023**: 系统必须支持交易记录的聚合统计(按日/月/年汇总交易次数、盈亏)
- **FR-024**: 系统必须区分记录类型(买入委托、卖出委托、成交、撤单)

#### K线历史数据 (优先级: P2 - 一般)
- **FR-025**: 系统必须支持存储5000只股票的5年日线数据
- **FR-026**: 系统必须支持按股票代码和日期范围查询K线数据
- **FR-027**: 系统必须支持批量查询多只股票的K线数据(最多100只/次)
- **FR-028**: 系统必须对K线数据进行压缩存储,压缩比不低于5:1

#### 用户权限管理 (优先级: P2 - 一般)
- **FR-029**: 系统必须支持用户注册、登录、注销功能
- **FR-030**: 系统必须支持角色管理(管理员、策略开发、交易员、只读用户)
- **FR-031**: 系统必须支持权限验证(如只有管理员可创建账户)
- **FR-032**: 系统必须记录用户的最后登录时间和登录IP

#### Web管理界面 (优先级: P2 - 一般)
- **FR-033**: 系统必须提供Web界面访问账户列表和详情
- **FR-034**: 系统必须提供Web界面访问策略列表和参数配置
- **FR-035**: 系统必须提供Web界面查询交易记录并导出CSV
- **FR-036**: 系统必须在150ms内响应Web界面的所有查询请求

#### 数据迁移与兼容性 (优先级: P1 - 重要)
- **FR-037**: 系统必须提供从旧存储迁移到新存储的工具
- **FR-038**: 系统必须在迁移过程中保证现有策略代码无需修改
- **FR-039**: 系统必须支持配置开关,允许快速回滚到旧存储模式
- **FR-040**: 系统必须验证迁移后的数据一致性(对比新旧存储内容)

### Non-Functional Requirements

#### 性能指标
- **NFR-001**: 系统在单机环境下必须支持并发访问(3个账户同时操作)
- **NFR-002**: 系统在高峰时段(盘中交易时间)的响应时间不得超过正常时段的2倍
- **NFR-003**: 系统必须在内存占用<4GB的限制下运行

#### 可靠性
- **NFR-004**: 系统的数据降级机制必须在1秒内自动触发(检测到主存储不可用后)
- **NFR-005**: 系统必须保证7×24小时持续运行,存储服务重启不影响应用可用性
- **NFR-006**: 系统必须记录所有存储操作错误,并通过钉钉/邮件发送告警

#### 可维护性
- **NFR-007**: 系统必须提供统一的数据访问接口,对上层策略代码透明
- **NFR-008**: 系统必须提供健康检查接口,返回各存储服务的连接状态
- **NFR-009**: 系统必须提供数据备份和恢复工具,支持一键备份/恢复

#### 扩展性
- **NFR-010**: 系统架构必须支持未来扩展到10+账户(当前设计容量为2-3账户)
- **NFR-011**: 系统必须支持插拔式存储后端(可替换不同存储技术)
- **NFR-012**: 系统必须为未来引入消息队列预留接口(如交易信号异步推送)

### Key Entities *(核心数据概念)*

- **Account (账户)**: 代表一个交易账户,记录资金、持仓等信息,账户ID全局唯一
- **Strategy (策略)**: 代表一个交易策略,可绑定多个账户,策略名称全局唯一
- **StrategyParam (策略参数)**: 策略参数的某个版本,支持版本对比,同一参数只能有一个激活版本
- **Position (持仓)**: 某账户在某股票上的持仓状态,记录持仓天数、最高价等,买入时创建、卖出时删除
- **Trade (交易记录)**: 每笔交易的详细信息,包括时间、价格、数量、策略等
- **DailyKline (K线数据)**: 股票的日线历史数据,支持按代码和日期查询,数据量约625万条
- **User (用户)**: Web管理后台的登录用户,用户名和邮箱全局唯一
- **Role (角色)**: 用户权限集合,预定义角色包括:管理员、策略开发、交易员、只读用户
- **Permission (权限)**: 具体操作权限,如"查看账户"、"管理策略"、"执行交易"

---

## Constraints & Assumptions *(约束与假设)*

### 业务约束
- **CON-001**: 系统当前仅支持股票交易,不支持期货、期权
- **CON-002**: 系统仅支持国内A股市场,交易时间为交易日的9:30-15:00
- **CON-003**: 系统设计容量为2-3个交易账户,单账户最多持仓100只股票
- **CON-004**: 系统运行在Windows环境,依赖QMT客户端本地运行

### 技术约束
- **CON-005**: 存储服务运行在本地(localhost),不考虑分布式部署
- **CON-006**: 系统假设单机环境,内存限制为16GB,磁盘空间>100GB
- **CON-007**: 系统采用容器化部署存储服务,要求用户已安装Docker/Podman

### 假设条件
- **ASM-001**: 假设用户具备基本的命令行操作能力
- **ASM-002**: 假设用户已开通QMT交易权限,并配置好credentials.py
- **ASM-003**: 假设网络连接稳定,可正常访问数据源(akshare/tushare/mootdx)
- **ASM-004**: 假设用户理解量化交易基本概念(持仓、止损、策略参数等)

### 依赖项
- **DEP-001**: 依赖容器化环境(Docker或Podman)
- **DEP-002**: 依赖高性能存储服务(内存数据库、列式数据库、关系数据库)
- **DEP-003**: 依赖Python 3.10+及相关第三方库
- **DEP-004**: 依赖QMT客户端正常运行并提供行情数据

---

## Success Criteria *(成功标准)*

### 性能指标达成
- ✅ 持仓状态查询响应时间<1ms (对比当前10ms,提升10倍)
- ✅ 交易记录查询响应时间<100ms (对比当前全表扫描>200ms,提升2倍)
- ✅ K线查询响应时间<20ms (对比当前CSV读取45ms,提升2倍)
- ✅ 跨账户统计查询<500ms (当前不支持)

### 功能完整性
- ✅ 支持2-3个账户的独立管理和跨账户查询
- ✅ 支持策略参数的版本化管理,可对比不同版本
- ✅ 支持Web管理界面的账户/策略/交易记录查询
- ✅ 支持用户权限管理(至少4种角色:管理员/开发/交易员/只读)

### 可靠性保障
- ✅ 存储服务故障时能自动降级,应用不中断
- ✅ 数据迁移过程可回滚,现有策略代码零修改
- ✅ 7×24小时运行,存储服务重启后应用自动重连

### 用户体验
- ✅ 策略代码仅需修改初始化部分即可完成集成(约5处)
- ✅ 部署过程脚本化(执行启动脚本即可)
- ✅ 提供详细文档(部署文档、迁移文档、回滚文档)

### 可测试性
- ✅ 提供性能基准测试工具,可验证各项性能指标
- ✅ 提供数据一致性验证工具,对比新旧存储内容
- ✅ 提供并发压力测试工具,验证3账户同时操作场景

---

## Out of Scope *(不包含的范围)*

以下内容明确不在本期功能范围内,避免范围蔓延:

### 技术架构层面
- ❌ 不支持分布式部署(主从复制、读写分离、分库分表)
- ❌ 不支持微服务拆分(账户服务、交易服务、查询服务)
- ❌ 不支持消息队列异步处理
- ❌ 不支持全文检索功能

### 业务功能层面
- ❌ 不支持期货、期权交易(仅支持股票)
- ❌ 不支持港股、美股市场(仅支持A股)
- ❌ 不支持AI自动调参(参数优化需人工分析)
- ❌ 不支持实时监控告警仪表盘
- ❌ 不支持移动端APP(仅Web界面)

### 用户体验层面
- ❌ 不提供可视化图表(K线图、资金曲线图)
- ❌ 不提供拖拽式策略配置界面(仍需编写代码)
- ❌ 不提供多语言支持(仅中文界面)
- ❌ 不提供导出PDF报告功能(仅支持CSV导出)

### 运维管理层面
- ❌ 不提供自动化CI/CD部署
- ❌ 不提供数据备份自动上云(仅本地备份)
- ❌ 不提供集中式日志分析平台(仅记录到文件)
- ❌ 不提供性能监控仪表盘(需手动执行基准测试)

---

## Review & Acceptance Checklist
*GATE: 自动检查项*

### Content Quality
- [x] 无实现细节(未指定具体技术栈、框架、库)
- [x] 关注用户价值和业务需求
- [x] 面向非技术利益相关者(业务决策者可理解)
- [x] 所有必填章节已完成

### Requirement Completeness
- [x] 无[NEEDS CLARIFICATION]标记(所有需求明确)
- [x] 需求可测试且无歧义
- [x] 成功标准可衡量(具体性能指标)
- [x] 范围清晰界定(Out of Scope明确)
- [x] 依赖和假设已识别

### Business Value Validation
- [x] 明确解决的问题:文件存储的性能瓶颈和业务扩展限制
- [x] 明确目标用户:交易员、策略开发者、系统管理员
- [x] 明确业务价值:支持多账户管理、策略参数优化、Web管理界面
- [x] 明确性能提升:查询速度提升2-10倍,存储空间节省90%

---

## Execution Status
*由main()在处理过程中更新*

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 歧义已标注(本规范无歧义)
- [x] 用户场景已定义(5个主场景+3类边界场景)
- [x] 需求已生成(40项功能需求+12项非功能需求)
- [x] 实体已识别(9个核心数据概念)
- [x] 审查检查清单已通过
- [x] 影响分析已完成(详见impact-analysis.md)

---

## Next Steps

**规范编写完成日期**: 2025-10-01
**当前状态**: Ready for Implementation
**下一阶段**: 设计阶段 (执行 `/plan` 生成设计文档)
**预估实施周期**: 4-5周
  - Week 1: 基础设施部署
  - Week 2-3: 接口开发+数据迁移(双写模式)
  - Week 4: 应用集成(切换到新存储)
  - Week 5: Web界面开发(可选)

**参考文档**:
- `impact-analysis.md` - 现有功能影响分析、三阶段实施方案、成本收益评估
- `spec-detailed-backup.md` - 详细技术规范备份(含数据实体关系、表结构设计)
- `docs/项目介绍/04-数据模块性能优化方案-MVP.md` - MVP版设计方案
- `docs/项目介绍/05-数据模块性能优化方案-完整版.md` - 完整版设计方案
